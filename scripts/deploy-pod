#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "${BASH_SOURCE[0]}")/.."

# https://github.com/tailscale/tailscale/issues/12409
traccar_host_ip=$( \
  ssh ubuntu@traccar-host.himalayan-tortoise.ts.net \
  curl --silent api.ipify.org \
)
podman system connection remove traccar
# Assumes ssh-agent contains key
podman system connection add traccar \
  "ssh://ubuntu@${traccar_host_ip}/run/user/1000/podman/podman.sock"
podman --connection=traccar kube play --replace "${PODMAN_SECRETS_FILE}"
podman --connection=traccar kube play --replace pod.yaml
